<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Central de Comunica√ß√£o Hospitalar</title>

<style>
  :root{
    --bg1:#0b1220;
    --bg2:#0a2a5e;
    --card:rgba(255,255,255,.10);
    --card2:rgba(255,255,255,.14);
    --stroke:rgba(255,255,255,.16);
    --text:rgba(255,255,255,.92);
    --muted:rgba(255,255,255,.72);
    --shadow:0 20px 60px rgba(0,0,0,.45);
    --shadow2:0 10px 30px rgba(0,0,0,.35);
    --r16:16px;
    --r24:24px;
    --ok:#35c759;
    --warn:#ffcc00;
    --bad:#ff3b30;
    --blue:#0a84ff;
    --vio:#bf5af2;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Inter,Roboto,Arial,sans-serif;
    color:var(--text);
    min-height:100vh;
    background:
      radial-gradient(900px 500px at 20% 10%, rgba(191,90,242,.35), transparent 60%),
      radial-gradient(900px 500px at 80% 0%, rgba(10,132,255,.40), transparent 55%),
      radial-gradient(900px 500px at 60% 90%, rgba(53,199,89,.20), transparent 60%),
      linear-gradient(160deg, var(--bg1), var(--bg2));
    overflow-x:hidden;
  }
  .noise{
    pointer-events:none;
    position:fixed; inset:0;
    background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='160' height='160'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='160' height='160' filter='url(%23n)' opacity='.18'/%3E%3C/svg%3E");
    mix-blend-mode:overlay;
    opacity:.35;
  }
  a{color:inherit}
  .wrap{
    max-width:1160px;
    margin:0 auto;
    padding:18px 16px 60px;
  }

  /* Topbar */
  .topbar{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    margin-bottom:14px;
  }
  .brand{
    display:flex; align-items:center; gap:12px;
  }
  .logo{
    width:38px; height:38px; border-radius:14px;
    background:linear-gradient(145deg, rgba(255,255,255,.16), rgba(255,255,255,.06));
    border:1px solid var(--stroke);
    box-shadow:var(--shadow2);
    position:relative;
    overflow:hidden;
  }
  .logo:before{
    content:"";
    position:absolute; inset:-40%;
    background:radial-gradient(circle at 30% 30%, rgba(10,132,255,.6), transparent 55%),
               radial-gradient(circle at 70% 70%, rgba(191,90,242,.5), transparent 55%);
    transform:rotate(10deg);
  }
  .titleblock .t1{
    font-size:14px;
    color:var(--muted);
    letter-spacing:.2px;
  }
  .titleblock .t2{
    font-size:18px;
    font-weight:700;
    letter-spacing:.2px;
  }
  .userpill{
    display:flex; align-items:center; gap:10px;
    padding:10px 12px;
    border-radius:999px;
    background:var(--card);
    border:1px solid var(--stroke);
    backdrop-filter: blur(14px);
    -webkit-backdrop-filter: blur(14px);
  }
  .dot{
    width:10px; height:10px; border-radius:50%;
    background:var(--ok);
    box-shadow:0 0 0 4px rgba(53,199,89,.18);
  }
  .userpill .meta{
    display:flex; flex-direction:column; line-height:1.1;
  }
  .userpill .meta b{font-size:13px}
  .userpill .meta span{font-size:12px; color:var(--muted)}
  .btn{
    appearance:none;
    border:1px solid var(--stroke);
    background:linear-gradient(180deg, rgba(255,255,255,.16), rgba(255,255,255,.08));
    color:var(--text);
    padding:10px 12px;
    border-radius:14px;
    cursor:pointer;
    box-shadow:var(--shadow2);
    transition:transform .12s ease, filter .12s ease;
  }
  .btn:active{ transform:scale(.98) }
  .btn.primary{
    border-color:rgba(10,132,255,.45);
    background:linear-gradient(180deg, rgba(10,132,255,.35), rgba(10,132,255,.18));
  }
  .btn.danger{
    border-color:rgba(255,59,48,.5);
    background:linear-gradient(180deg, rgba(255,59,48,.35), rgba(255,59,48,.16));
  }
  .btn.ghost{
    background:transparent;
    box-shadow:none;
  }

  /* Glass card */
  .glass{
    background:var(--card);
    border:1px solid var(--stroke);
    border-radius:var(--r24);
    backdrop-filter: blur(18px);
    -webkit-backdrop-filter: blur(18px);
    box-shadow:var(--shadow);
  }

  /* Layout */
  .grid{
    display:grid;
    grid-template-columns: 360px 1fr;
    gap:16px;
  }
  @media(max-width: 980px){
    .grid{ grid-template-columns: 1fr; }
  }

  /* Sidebar */
  .side{
    padding:16px;
  }
  .navtitle{
    font-size:12px;
    color:var(--muted);
    letter-spacing:.25px;
    margin:6px 2px 12px;
  }
  .nav{
    display:flex;
    flex-direction:column;
    gap:10px;
  }
  .nav .item{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    padding:12px 12px;
    border-radius:16px;
    border:1px solid rgba(255,255,255,.10);
    background:rgba(255,255,255,.08);
    cursor:pointer;
    transition:transform .12s ease, filter .12s ease, background .12s ease;
  }
  .nav .item:hover{ filter:brightness(1.05) }
  .nav .item:active{ transform:scale(.99) }
  .nav .item .left{
    display:flex; align-items:center; gap:12px;
  }
  .ic{
    width:36px;height:36px;border-radius:14px;
    display:grid;place-items:center;
    border:1px solid rgba(255,255,255,.14);
    background:rgba(255,255,255,.10);
  }
  .ic svg{ width:18px; height:18px; opacity:.95 }
  .item b{ font-size:14px }
  .item small{ display:block; color:var(--muted); font-size:12px; margin-top:2px }
  .chip{
    font-size:11px;
    padding:6px 10px;
    border-radius:999px;
    border:1px solid rgba(255,255,255,.16);
    background:rgba(0,0,0,.12);
    color:var(--muted);
    white-space:nowrap;
  }
  .chip.red{ border-color:rgba(255,59,48,.35); color:rgba(255,255,255,.92); background:rgba(255,59,48,.18) }
  .chip.blue{ border-color:rgba(10,132,255,.35); color:rgba(255,255,255,.92); background:rgba(10,132,255,.18) }
  .chip.green{ border-color:rgba(53,199,89,.35); color:rgba(255,255,255,.92); background:rgba(53,199,89,.18) }
  .chip.yellow{ border-color:rgba(255,204,0,.35); color:rgba(255,255,255,.92); background:rgba(255,204,0,.16) }

  /* Main */
  .main{
    padding:16px;
  }
  .hero{
    padding:18px;
    border-radius:22px;
    background:linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,.06));
    border:1px solid rgba(255,255,255,.16);
  }
  .hero h2{
    margin:0 0 6px 0;
    font-size:18px;
    letter-spacing:.2px;
  }
  .hero p{
    margin:0;
    color:var(--muted);
    font-size:13px;
    line-height:1.35;
  }

  .section{
    margin-top:14px;
    padding:16px;
    border-radius:22px;
    background:rgba(255,255,255,.08);
    border:1px solid rgba(255,255,255,.12);
  }
  .sectionhead{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    margin-bottom:12px;
  }
  .sectionhead h3{
    margin:0;
    font-size:14px;
    letter-spacing:.2px;
  }
  .row{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:10px;
  }
  @media(max-width: 680px){
    .row{ grid-template-columns: 1fr; }
  }
  .field label{
    display:block;
    font-size:12px;
    color:var(--muted);
    margin:0 0 6px 2px;
  }
  .field input, .field select, .field textarea{
    width:100%;
    padding:12px 12px;
    border-radius:14px;
    border:1px solid rgba(255,255,255,.14);
    background:rgba(0,0,0,.18);
    color:var(--text);
    outline:none;
  }
  .field textarea{ min-height:88px; resize:vertical }
  .actions{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    margin-top:12px;
  }
  .statusbar{
    padding:16px;
    border-radius:20px;
    border:1px solid rgba(255,255,255,.16);
    background:rgba(0,0,0,.18);
    display:flex;
    flex-direction:column;
    gap:12px;
  }
  .status-meta{
    display:flex;
    align-items:flex-start;
    justify-content:space-between;
    gap:12px;
    flex-wrap:wrap;
  }
  .status-title{
    font-size:15px;
    font-weight:600;
    letter-spacing:.2px;
  }
  .status-sub{
    font-size:12px;
    color:var(--muted);
  }
  .status-grid{
    display:grid;
    grid-template-columns: repeat(3, minmax(0,1fr));
    gap:10px;
  }
  @media(max-width: 720px){
    .status-grid{ grid-template-columns: 1fr; }
  }
  .status-item{
    padding:12px;
    border-radius:16px;
    border:1px solid rgba(255,255,255,.12);
    background:rgba(255,255,255,.06);
  }
  .status-item b{
    font-size:20px;
    display:block;
    margin-bottom:4px;
  }
  .status-item span{
    font-size:12px;
    color:var(--muted);
  }
  .status-item.bad{ border-color:rgba(255,59,48,.45); }
  .status-item.warn{ border-color:rgba(255,204,0,.45); }
  .status-item.ok{ border-color:rgba(53,199,89,.45); }
  .status-foot{
    font-size:12px;
    color:var(--muted);
  }
  .heroAction{
    margin-top:14px;
    padding:16px;
    border-radius:22px;
    border:1px solid rgba(255,255,255,.16);
    background:linear-gradient(180deg, rgba(255,59,48,.20), rgba(255,59,48,.08));
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:14px;
    flex-wrap:wrap;
  }
  .heroAction .heroBtn{
    appearance:none;
    border:none;
    border-radius:18px;
    padding:14px 22px;
    font-size:15px;
    font-weight:600;
    color:#fff;
    background:linear-gradient(180deg, rgba(255,59,48,.95), rgba(255,59,48,.70));
    box-shadow:0 14px 30px rgba(255,59,48,.25);
    cursor:pointer;
  }
  .heroAction .heroBtn:active{ transform:scale(.98) }
  .heroAction .heroText{
    font-size:12px;
    color:var(--muted);
  }
  .alertlist{
    display:flex;
    flex-direction:column;
    gap:10px;
  }
  .alert-item{
    padding:12px;
    border-radius:16px;
    border:1px solid rgba(255,204,0,.40);
    background:rgba(255,204,0,.10);
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    font-size:13px;
  }
  .alert-item strong{
    font-size:13px;
  }
  .action-grid{
    display:grid;
    grid-template-columns: repeat(2, minmax(0,1fr));
    gap:10px;
  }
  @media(max-width: 680px){
    .action-grid{ grid-template-columns: 1fr; }
  }
  .action-card{
    padding:12px 14px;
    border-radius:16px;
    border:1px solid rgba(255,255,255,.12);
    background:rgba(255,255,255,.06);
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    cursor:pointer;
    transition:transform .12s ease, filter .12s ease;
  }
  .action-card:hover{ filter:brightness(1.05) }
  .action-card:active{ transform:scale(.99) }
  .action-card b{ font-size:14px }
  .action-card span{ font-size:12px; color:var(--muted) }
  .nav .item.nav-muted{
    background:rgba(255,255,255,.04);
    border-color:rgba(255,255,255,.08);
    opacity:.8;
  }
  .nav .item.nav-secondary{
    background:rgba(255,255,255,.06);
  }
  .nav .item.nav-primary{
    border-color:rgba(53,199,89,.45);
    background:linear-gradient(180deg, rgba(53,199,89,.22), rgba(53,199,89,.08));
  }
  .nav .item.nav-critical{
    border-color:rgba(255,59,48,.55);
    background:linear-gradient(180deg, rgba(255,59,48,.22), rgba(255,59,48,.08));
  }

  /* Tables / Lists */
  .list{
    display:flex;
    flex-direction:column;
    gap:10px;
  }
  .cardrow{
    padding:14px;
    border-radius:18px;
    border:1px solid rgba(255,255,255,.12);
    background:rgba(255,255,255,.08);
    cursor:pointer;
    transition:transform .12s ease, filter .12s ease;
  }
  .cardrow:hover{ filter:brightness(1.05) }
  .cardrow:active{ transform:scale(.995) }
  .cardrow .top{
    display:flex;
    align-items:flex-start;
    justify-content:space-between;
    gap:12px;
  }
  .cardrow .top b{
    font-size:14px;
    display:block;
    margin-bottom:3px;
  }
  .cardrow .sub{
    color:var(--muted);
    font-size:12px;
    line-height:1.35;
  }
  .metaLine{
    display:flex;
    gap:8px;
    flex-wrap:wrap;
    margin-top:10px;
  }

  /* Timeline */
  .timeline{
    position:relative;
    padding-left:18px;
  }
  .timeline:before{
    content:"";
    position:absolute;
    left:7px; top:4px; bottom:4px;
    width:2px;
    background:linear-gradient(180deg, rgba(255,255,255,.24), rgba(255,255,255,.08));
    border-radius:999px;
  }
  .ev{
    position:relative;
    padding:12px 12px 12px 14px;
    border-radius:18px;
    border:1px solid rgba(255,255,255,.12);
    background:rgba(255,255,255,.08);
    margin-bottom:10px;
  }
  .ev:before{
    content:"";
    position:absolute;
    left:-18px; top:16px;
    width:10px; height:10px;
    border-radius:50%;
    background:rgba(255,255,255,.9);
    box-shadow:0 0 0 5px rgba(255,255,255,.10);
  }
  .ev .h{
    display:flex; justify-content:space-between; gap:10px;
    margin-bottom:6px;
  }
  .ev .h b{ font-size:13px }
  .ev .h span{ font-size:11px; color:var(--muted) }
  .ev p{ margin:0; font-size:12.5px; color:rgba(255,255,255,.88); line-height:1.35 }
  .ev .tags{ margin-top:8px; display:flex; gap:8px; flex-wrap:wrap; }

  /* Modals */
  .modalback{
    position:fixed; inset:0;
    background:rgba(0,0,0,.55);
    display:none;
    align-items:center;
    justify-content:center;
    padding:16px;
    z-index:50;
  }
  .modal{
    width:min(680px, 100%);
    border-radius:24px;
    padding:16px;
    background:rgba(20,26,40,.88);
    border:1px solid rgba(255,255,255,.14);
    backdrop-filter: blur(18px);
    box-shadow:var(--shadow);
  }
  .modal .head{
    display:flex; align-items:center; justify-content:space-between; gap:10px;
    margin-bottom:10px;
  }
  .modal .head h4{ margin:0; font-size:14px }
  .modal .body{ padding:6px 2px 2px }
  .modal .foot{ display:flex; gap:10px; justify-content:flex-end; margin-top:12px; flex-wrap:wrap; }
  .x{
    border:none; background:transparent; color:var(--muted);
    font-size:18px; cursor:pointer; padding:6px 10px; border-radius:12px;
  }
  .x:hover{ background:rgba(255,255,255,.06); color:var(--text) }

  /* Toasts + loader */
  .toasts{
    position:fixed;
    right:14px; bottom:14px;
    display:flex; flex-direction:column; gap:10px;
    z-index:60;
  }
  .toast{
    min-width:280px;
    padding:12px 12px;
    border-radius:16px;
    background:rgba(20,26,40,.88);
    border:1px solid rgba(255,255,255,.14);
    box-shadow:var(--shadow2);
    backdrop-filter: blur(18px);
  }
  .toast b{ font-size:13px; display:block; margin-bottom:4px }
  .toast span{ font-size:12px; color:var(--muted); line-height:1.3 }
  .toast.ok{ border-color:rgba(53,199,89,.30) }
  .toast.bad{ border-color:rgba(255,59,48,.30) }
  .toast.warn{ border-color:rgba(255,204,0,.30) }
  .loader{
    position:fixed; inset:0;
    display:none;
    align-items:center;
    justify-content:center;
    z-index:55;
    background:rgba(0,0,0,.35);
    backdrop-filter: blur(4px);
  }
  .spinner{
    width:44px;height:44px;border-radius:50%;
    border:3px solid rgba(255,255,255,.25);
    border-top-color: rgba(255,255,255,.9);
    animation:spin 1s linear infinite;
  }
  @keyframes spin{ to{ transform:rotate(360deg) } }

  /* Login view */
  .loginbox{
    max-width:560px;
    margin: 10vh auto 0;
    padding:18px;
  }
  .loginbox h1{
    margin:0 0 6px;
    font-size:20px;
    letter-spacing:.2px;
  }
  .loginbox p{
    margin:0 0 16px;
    color:var(--muted);
    font-size:13px;
    line-height:1.35;
  }
  .loginrow{
    display:flex; gap:10px; flex-wrap:wrap;
  }
  .loginrow input{
    flex:1;
    padding:14px 14px;
    border-radius:16px;
    border:1px solid rgba(255,255,255,.14);
    background:rgba(0,0,0,.20);
    color:var(--text);
    font-size:16px;
    outline:none;
  }
  .loginrow .btn{ padding:14px 14px; border-radius:16px; }
  .hint{
    margin-top:10px;
    font-size:12px;
    color:var(--muted);
  }
</style>
</head>

<body>
<div class="noise"></div>

<div class="wrap">

  <!-- TOPBAR -->
  <div class="topbar" id="topbar" style="display:none;">
    <div class="brand">
      <div class="logo"></div>
      <div class="titleblock">
        <div class="t1">Central de Comunica√ß√£o</div>
        <div class="t2">Hospitalar</div>
      </div>
    </div>

    <div style="display:flex; gap:10px; align-items:center;">
      <div class="userpill" id="userpill">
        <div class="dot"></div>
        <div class="meta">
          <b id="uSetor">‚Äî</b>
          <span id="uRamal">Ramal ‚Äî</span>
        </div>
      </div>
      <button class="btn ghost" onclick="logout()" title="Sair">Sair</button>
    </div>
  </div>

  <!-- LOGIN -->
  <div class="glass loginbox" id="viewLogin">
    <h1>Entrar por ramal</h1>
    <p>R√°pido, sem senha. Identifica√ß√£o por setor. O Plant√£o Administrativo tem painel completo.</p>
    <div class="loginrow">
      <input id="inpRamal" inputmode="numeric" placeholder="Digite o ramal (ex: 1102)" />
      <button class="btn primary" onclick="doLogin()">Entrar</button>
    </div>
    <div class="hint">Dica: se der ‚Äúramal inv√°lido‚Äù, confira se est√° ativo em <b>CONFIG_RAMAL</b> e (para ADM) em <b>USUARIOS_PLANTAO</b>. O ramal ADM padr√£o vem como <b>2077</b> e pode ser trocado na aba <b>CONFIG_GERAL</b> (chave <code>DEFAULT_ADM_RAMAL</code>).</div>
  </div>

  <!-- APP -->
  <div class="grid" id="viewApp" style="display:none;">
    <!-- Sidebar -->
    <div class="glass side">
      <div class="navtitle">A√ß√µes</div>
      <div class="nav">
        <div class="item nav-muted" onclick="go('home')">
          <div class="left">
            <div class="ic">
              <svg viewBox="0 0 24 24" fill="none"><path d="M10 20v-6h4v6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><path d="M4 11l8-7 8 7v9a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2v-9Z" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
            </div>
            <div>
              <b>In√≠cio</b>
              <small>Atalhos e vis√£o r√°pida</small>
            </div>
          </div>
          <span class="chip blue">App</span>
        </div>

        <div class="item nav-secondary" onclick="go('solicitacaoNova')">
          <div class="left">
            <div class="ic">
              <svg viewBox="0 0 24 24" fill="none"><path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
            </div>
            <div>
              <b>Nova Solicita√ß√£o</b>
              <small>√ìbito, interconsulta pendente, exame pendente</small>
            </div>
          </div>
          <span class="chip">Geral</span>
        </div>

        <div class="item nav-secondary" onclick="go('solicitacoesMeus')">
          <div class="left">
            <div class="ic">
              <svg viewBox="0 0 24 24" fill="none"><path d="M7 7h10M7 12h10M7 17h6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
            </div>
            <div>
              <b>Minhas Solicita√ß√µes</b>
              <small>Somente as suas</small>
            </div>
          </div>
          <span class="chip">Lista</span>
        </div>

        <div class="item nav-primary" id="navSolicitacoesPlantao" onclick="go('solicitacoesPlantao')" style="display:none;">
          <div class="left">
            <div class="ic">
              <svg viewBox="0 0 24 24" fill="none"><path d="M4 5h16M4 12h16M4 19h10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
            </div>
            <div>
              <b>Painel Solicita√ß√µes</b>
              <small>Todos os m√≥dulos gerais</small>
            </div>
          </div>
          <span class="chip green">ADM</span>
        </div>

        <div class="item nav-critical" onclick="go('sepseNovo')">
          <div class="left">
            <div class="ic">
              <svg viewBox="0 0 24 24" fill="none"><path d="M12 2v6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><path d="M12 22v-6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><path d="M4.93 4.93l4.24 4.24" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><path d="M14.83 14.83l4.24 4.24" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><path d="M2 12h6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><path d="M22 12h-6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><path d="M4.93 19.07l4.24-4.24" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><path d="M14.83 9.17l4.24-4.24" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
            </div>
            <div>
              <b>Abrir Sepse</b>
              <small>Iniciar protocolo</small>
            </div>
          </div>
          <span class="chip red">Cr√≠tico</span>
        </div>

        <div class="item nav-secondary" onclick="go('sepseMeus')">
          <div class="left">
            <div class="ic">
              <svg viewBox="0 0 24 24" fill="none"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><circle cx="12" cy="7" r="4" stroke="currentColor" stroke-width="2"/></svg>
            </div>
            <div>
              <b>Meus Protocolos</b>
              <small>O que eu abri</small>
            </div>
          </div>
          <span class="chip">Lista</span>
        </div>

        <div class="item nav-primary" id="navPlantao" onclick="go('plantao')" style="display:none;">
          <div class="left">
            <div class="ic">
              <svg viewBox="0 0 24 24" fill="none"><path d="M4 19V7a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v12" stroke="currentColor" stroke-width="2"/><path d="M6 9h12M6 13h8M6 17h10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
            </div>
            <div>
              <b>Painel do Plant√£o</b>
              <small>Todos os sepse</small>
            </div>
          </div>
          <span class="chip green">ADM</span>
        </div>
      </div>

      <div class="navtitle" style="margin-top:14px;">Atalhos</div>
      <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <button class="btn" onclick="refreshCurrent()">Atualizar</button>
        <button class="btn" onclick="go('home')">Voltar</button>
      </div>
    </div>

    <!-- Main -->
    <div class="glass main">
      <div class="hero" id="hero">
        <h2 id="heroTitle">In√≠cio</h2>
        <p id="heroDesc">Entre pelo ramal, abra o protocolo e registre os eventos em timeline. Plant√£o recebe tudo.</p>
      </div>

      <!-- HOME -->
      <div class="section" id="pageHome">
        <div class="sectionhead">
          <h3>Estado do plant√£o</h3>
          <span class="chip">tempo real</span>
        </div>
        <div class="statusbar">
          <div class="status-meta">
            <div>
              <div class="status-title" id="homeShiftTitle">Plant√£o Administrativo ‚Äî Ramal 2077</div>
              <div class="status-sub" id="homeShiftTime">Turno atual: 07:00‚Äì19:00</div>
            </div>
            <span class="chip blue" id="homeShiftUnit">Centro de comando</span>
          </div>
          <div class="status-grid">
            <div class="status-item bad">
              <b id="homeSepseAbertos">‚Äî</b>
              <span>üî¥ Sepse abertos</span>
            </div>
            <div class="status-item warn">
              <b id="homePendentes">‚Äî</b>
              <span>üü° Pendentes 6h</span>
            </div>
            <div class="status-item ok">
              <b id="homeConcluidos">‚Äî</b>
              <span>üü¢ Conclu√≠dos hoje</span>
            </div>
          </div>
          <div class="status-foot">√öltima atualiza√ß√£o: <b id="homeUpdated">‚Äî</b></div>
        </div>

        <div class="heroAction">
          <button class="heroBtn" onclick="go('sepseNovo')">+ Abrir Protocolo Sepse</button>
          <div class="heroText">A√ß√£o cr√≠tica ¬∑ registro imediato</div>
        </div>

        <div class="sectionhead" style="margin-top:14px;">
          <h3>Aten√ß√£o agora</h3>
          <span class="chip yellow">alertas</span>
        </div>
        <div class="alertlist" id="homeAlerts"></div>

        <div class="sectionhead" style="margin-top:14px;">
          <h3>A√ß√µes r√°pidas</h3>
          <span class="chip">secund√°rio</span>
        </div>
        <div class="action-grid" id="homeActions"></div>
      </div>

      <!-- SOLICITA√á√ÉO NOVA -->
      <div class="section" id="pageSolicitacaoNova" style="display:none;">
        <div class="sectionhead">
          <h3>Nova Solicita√ß√£o</h3>
          <span class="chip">M√≥dulos gerais</span>
        </div>
        <div class="row">
          <div class="field">
            <label>Tipo</label>
            <select id="gTipo" onchange="atualizarCamposSolicitacao()">
              <option value="OBITO">Declara√ß√£o de √ìbito</option>
              <option value="INTERCONSULTA">Interconsulta pendente</option>
              <option value="EXAMES">Exame Pendente</option>
            </select>
          </div>
          <div class="field">
            <label>Nome do solicitante</label>
            <input id="gNomeSolicitante" placeholder="Nome ou respons√°vel" />
          </div>
          <div class="field">
            <label>Prioridade</label>
            <select id="gPrioridade">
              <option value="NORMAL">Normal</option>
              <option value="ALTA">Alta</option>
              <option value="CRITICA">Cr√≠tica</option>
            </select>
          </div>
          <div class="field">
            <label>Observa√ß√£o</label>
            <input id="gObservacao" placeholder="Opcional" />
          </div>
        </div>

        <div id="grpObito" style="margin-top:12px;">
          <div class="row">
            <div class="field">
              <label>Paciente</label>
              <input id="gObitoPaciente" placeholder="Nome do paciente" />
            </div>
            <div class="field">
              <label>Prontu√°rio</label>
              <input id="gObitoProntuario" placeholder="N√∫mero do prontu√°rio" />
            </div>
            <div class="field">
              <label>Leito</label>
              <input id="gObitoLeito" placeholder="Ex: B514" />
            </div>
            <div class="field">
              <label>Cl√≠nica</label>
              <input id="gObitoClinica" placeholder="Ex: Cl√≠nica m√©dica" />
            </div>
            <div class="field">
              <label>Data do √≥bito</label>
              <input id="gObitoData" type="datetime-local" />
            </div>
          </div>
        </div>

        <div id="grpInterconsulta" style="margin-top:12px; display:none;">
          <div class="row">
            <div class="field">
              <label>Paciente</label>
              <input id="gInterPaciente" placeholder="Nome do paciente" />
            </div>
            <div class="field">
              <label>Prontu√°rio</label>
              <input id="gInterProntuario" placeholder="N√∫mero do prontu√°rio" />
            </div>
            <div class="field">
              <label>Cl√≠nica</label>
              <input id="gInterClinica" placeholder="Ex: Cl√≠nica m√©dica" />
            </div>
            <div class="field">
              <label>Especialidade</label>
              <input id="gInterEspecialidade" placeholder="Ex: Cardiologia" />
            </div>
          </div>
        </div>

        <div id="grpExames" style="margin-top:12px; display:none;">
          <div class="row">
            <div class="field">
              <label>Paciente</label>
              <input id="gExamePaciente" placeholder="Nome do paciente" />
            </div>
            <div class="field">
              <label>Prontu√°rio</label>
              <input id="gExameProntuario" placeholder="N√∫mero do prontu√°rio" />
            </div>
            <div class="field">
              <label>Exame</label>
              <input id="gExameNome" placeholder="Ex: Tomografia, Hemograma" />
            </div>
            <div class="field">
              <label>Data da solicita√ß√£o</label>
              <input id="gExameData" type="datetime-local" />
            </div>
            <div class="field">
              <label>Solicitante</label>
              <input id="gExameSolicitante" placeholder="Nome do solicitante" />
            </div>
          </div>
        </div>

        <div class="actions">
          <button class="btn primary" onclick="criarSolicitacao()">Abrir solicita√ß√£o</button>
          <button class="btn" onclick="go('home')">Cancelar</button>
        </div>
      </div>

      <!-- SOLICITA√á√ïES MEUS -->
      <div class="section" id="pageSolicitacoesMeus" style="display:none;">
        <div class="sectionhead">
          <h3>Minhas Solicita√ß√µes</h3>
          <span class="chip">por ramal</span>
        </div>
        <div class="list" id="solicitacoesMeusList"></div>
      </div>

      <!-- SOLICITA√á√ïES PLANTAO -->
      <div class="section" id="pageSolicitacoesPlantao" style="display:none;">
        <div class="sectionhead">
          <h3>Painel de Solicita√ß√µes</h3>
          <div style="display:flex; gap:10px; flex-wrap:wrap;">
            <select id="fltSolicStatus" class="btn" onchange="carregarSolicitacoesPlantao()">
              <option value="TODOS">Todos os status</option>
              <option value="ABERTO">Aberto</option>
              <option value="EM ANDAMENTO">Em andamento</option>
              <option value="CONCLUIDO">Conclu√≠do</option>
              <option value="CANCELADO">Cancelado</option>
            </select>
            <select id="fltSolicTipo" class="btn" onchange="carregarSolicitacoesPlantao()">
              <option value="TODOS">Todos os tipos</option>
              <option value="OBITO">√ìbito</option>
              <option value="INTERCONSULTA">Interconsulta pendente</option>
              <option value="EXAMES">Exame Pendente</option>
            </select>
            <button class="btn" onclick="carregarSolicitacoesPlantao()">Recarregar</button>
          </div>
        </div>
        <div class="list" id="solicitacoesPlantaoList"></div>
      </div>

      <!-- SOLICITA√á√ÉO DETALHE -->
      <div class="section" id="pageSolicitacaoDetalhe" style="display:none;">
        <div class="sectionhead">
          <h3>Solicita√ß√£o</h3>
          <div style="display:flex; gap:10px; flex-wrap:wrap;">
            <span class="chip blue" id="gDetalheTipo">‚Äî</span>
            <span class="chip" id="gDetalheStatus">‚Äî</span>
          </div>
        </div>
        <div id="gDetalheCard"></div>
      </div>

      <!-- SEPSE NOVO -->
      <div class="section" id="pageSepseNovo" style="display:none;">
        <div class="sectionhead">
          <h3>Abrir Protocolo Sepse</h3>
          <span class="chip red">Registro imediato</span>
        </div>
        <div class="row">
          <div class="field">
            <label>Paciente</label>
            <input id="sPaciente" placeholder="Nome do paciente" />
          </div>
          <div class="field">
            <label>Prontu√°rio</label>
            <input id="sProntuario" placeholder="N√∫mero do prontu√°rio" />
          </div>
          <div class="field">
            <label>Leito</label>
            <input id="sLeito" placeholder="Ex: B514" />
          </div>
          <div class="field">
            <label>Unidade</label>
            <input id="sUnidade" placeholder="Ex: B5 Cirurgia Oncol√≥gica" />
          </div>
          <div class="field">
            <label>M√©dico respons√°vel</label>
            <input id="sMedico" placeholder="Nome do m√©dico" />
          </div>
          <div class="field">
            <label>Observa√ß√µes</label>
            <input id="sObs" placeholder="Opcional" />
          </div>
        </div>
        <div class="actions">
          <button class="btn primary" onclick="criarSepse()">Abrir protocolo</button>
          <button class="btn" onclick="go('home')">Cancelar</button>
        </div>
      </div>

      <!-- SEPSE MEUS -->
      <div class="section" id="pageSepseMeus" style="display:none;">
        <div class="sectionhead">
          <h3>Meus Protocolos</h3>
          <span class="chip">por ramal</span>
        </div>
        <div class="list" id="meusList"></div>
      </div>

      <!-- PLANTAO -->
      <div class="section" id="pagePlantao" style="display:none;">
        <div class="sectionhead">
          <h3>Painel do Plant√£o</h3>
          <div style="display:flex; gap:10px; flex-wrap:wrap;">
            <select id="fltStatus" class="btn" onchange="carregarPlantao()">
              <option value="TODOS">Todos</option>
              <option value="ABERTO">Aberto</option>
              <option value="CONCLUIDO">Conclu√≠do</option>
              <option value="CANCELADO">Cancelado</option>
            </select>
            <button class="btn" onclick="carregarPlantao()">Recarregar</button>
          </div>
        </div>
        <div class="list" id="plantaoList"></div>
      </div>

      <!-- DETALHE SEPSE -->
      <div class="section" id="pageSepseDetalhe" style="display:none;">
        <div class="sectionhead">
          <h3>Protocolo Sepse</h3>
          <div style="display:flex; gap:10px; flex-wrap:wrap;">
            <span class="chip red" id="dStatus">‚Äî</span>
            <span class="chip" id="dMeta">‚Äî</span>
          </div>
        </div>

        <div id="detailCard" style="margin-bottom:12px;"></div>

        <div class="actions" id="detailActions"></div>

        <div class="sectionhead" style="margin-top:14px;">
          <h3>Timeline</h3>
          <span class="chip blue">Eventos</span>
        </div>
        <div class="timeline" id="timeline"></div>
      </div>

    </div>
  </div>

</div>

<!-- Modal: Registrar liga√ß√£o -->
<div class="modalback" id="modalBack">
  <div class="modal">
    <div class="head">
      <h4>Registrar liga√ß√£o</h4>
      <button class="x" onclick="closeModal()">√ó</button>
    </div>
    <div class="body">
      <div class="row">
        <div class="field">
          <label>Setor</label>
          <select id="mSetor"></select>
        </div>
        <div class="field">
          <label>Resultado</label>
          <select id="mResultado">
            <option>ATENDEU</option>
            <option>SEM CONTATO</option>
            <option>OCUPADO</option>
            <option>RAMAL INEXISTENTE</option>
            <option>J√Å CIENTE</option>
          </select>
        </div>
      </div>
      <div class="field">
        <label>Observa√ß√£o (opcional)</label>
        <input id="mObs" placeholder="Ex: informou que vai priorizar / pediu retorno / etc." />
      </div>
    </div>
    <div class="foot">
      <button class="btn" onclick="closeModal()">Cancelar</button>
      <button class="btn primary" onclick="confirmLigacao()">Registrar</button>
    </div>
  </div>
</div>

<!-- Loader / Toasts -->
<div class="loader" id="loader"><div class="spinner"></div></div>
<div class="toasts" id="toasts"></div>

<script>
/* =========================
   STATE
========================= */
const S = {
  user: null,
  isAdm: false,
  setoresSepse: [],
  current: { page:'home', sepseId:null, sepse:null, timeline:[], solicitacaoId:null, solicitacao:null }
};

/* =========================
   UI utils
========================= */
function $(id){ return document.getElementById(id); }
function showLoader(on=true){ $('loader').style.display = on ? 'flex' : 'none'; }
function toast(type, title, msg){
  const el = document.createElement('div');
  el.className = `toast ${type||''}`;
  el.innerHTML = `<b>${escapeHtml(title||'')}</b><span>${escapeHtml(msg||'')}</span>`;
  $('toasts').appendChild(el);
  setTimeout(()=>{ el.style.opacity='0'; el.style.transform='translateY(6px)'; }, 2600);
  setTimeout(()=>{ el.remove(); }, 3200);
}
function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m])); }
function setHero(t,d){ $('heroTitle').textContent=t; $('heroDesc').textContent=d; }

function go(page){
  S.current.page = page;
  // hide all pages
  ['pageHome','pageSolicitacaoNova','pageSolicitacoesMeus','pageSolicitacoesPlantao','pageSolicitacaoDetalhe','pageSepseNovo','pageSepseMeus','pagePlantao','pageSepseDetalhe'].forEach(id => $(id).style.display='none');

  if (page==='home'){
    setHero('Central do Plant√£o','Estado vivo, a√ß√£o cr√≠tica em destaque.');
    $('pageHome').style.display='block';
    renderHome();
  }
  if (page==='solicitacaoNova'){
    setHero('Nova Solicita√ß√£o','√ìbito, interconsulta pendente e exame pendente em fluxo direto.');
    $('pageSolicitacaoNova').style.display='block';
    atualizarCamposSolicitacao();
  }
  if (page==='solicitacoesMeus'){
    setHero('Minhas Solicita√ß√µes','O que voc√™ abriu pelo seu ramal.');
    $('pageSolicitacoesMeus').style.display='block';
    carregarSolicitacoesMeus();
  }
  if (page==='solicitacoesPlantao'){
    setHero('Painel de Solicita√ß√µes','Vis√£o global de todas as solicita√ß√µes gerais.');
    $('pageSolicitacoesPlantao').style.display='block';
    carregarSolicitacoesPlantao();
  }
  if (page==='solicitacaoDetalhe'){
    setHero('Solicita√ß√£o','Detalhes completos da solicita√ß√£o.');
    $('pageSolicitacaoDetalhe').style.display='block';
  }
  if (page==='sepseNovo'){
    setHero('Abrir Sepse','Preencha o m√≠nimo. O resto vira evento na timeline, sem bagun√ßa.');
    $('pageSepseNovo').style.display='block';
  }
  if (page==='sepseMeus'){
    setHero('Meus Protocolos','O que voc√™ abriu pelo seu ramal.');
    $('pageSepseMeus').style.display='block';
    carregarMeus();
  }
  if (page==='plantao'){
    setHero('Painel do Plant√£o','Vis√£o global. Filtre e abra o detalhe com timeline completa.');
    $('pagePlantao').style.display='block';
    carregarPlantao();
  }
  if (page==='sepseDetalhe'){
    setHero('Protocolo Sepse','A√ß√µes r√°pidas + timeline como di√°rio operacional.');
    $('pageSepseDetalhe').style.display='block';
  }
}

function refreshCurrent(){
  const p = S.current.page;
  if (p==='solicitacoesMeus') return carregarSolicitacoesMeus();
  if (p==='solicitacoesPlantao') return carregarSolicitacoesPlantao();
  if (p==='solicitacaoDetalhe' && S.current.solicitacaoId) return abrirDetalheSolicitacao(S.current.solicitacaoId);
  if (p==='sepseMeus') return carregarMeus();
  if (p==='plantao') return carregarPlantao();
  if (p==='sepseDetalhe' && S.current.sepseId) return abrirDetalheSepse(S.current.sepseId);
  renderHome();
}

/* =========================
   LOGIN
========================= */
function doLogin(){
  const ramal = $('inpRamal').value.trim();
  if (!ramal) return toast('warn','Faltou o ramal','Digite um ramal v√°lido.');

  showLoader(true);
  google.script.run.withSuccessHandler(user=>{
    if (!user){
      showLoader(false);
      toast('bad','Ramal inv√°lido','Confira CONFIG_RAMAL (ativo).');
      return;
    }
    S.user = user;

    google.script.run.withSuccessHandler(isAdm=>{
      S.isAdm = !!isAdm;
      $('viewLogin').style.display='none';
      $('viewApp').style.display='grid';
      $('topbar').style.display='flex';
      $('uSetor').textContent = user.setor || '‚Äî';
      $('uRamal').textContent = `Ramal ${user.ramal}`;
      $('navPlantao').style.display = S.isAdm ? 'flex' : 'none';
      $('navSolicitacoesPlantao').style.display = S.isAdm ? 'flex' : 'none';

      // carregar setores sepse
      google.script.run.withSuccessHandler(list=>{
        S.setoresSepse = list || [];
        // home
        go('home');
        showLoader(false);
        toast('ok','Entrou','Sistema pronto.');
      }).listarSetoresSepseAtivos();

    }).ehPlantao(user.ramal);

  }).validarRamal(ramal);
}

function logout(){
  S.user=null; S.isAdm=false; S.setoresSepse=[]; S.current={page:'home',sepseId:null,sepse:null,timeline:[],solicitacaoId:null,solicitacao:null};
  $('viewApp').style.display='none';
  $('topbar').style.display='none';
  $('viewLogin').style.display='block';
  $('inpRamal').value='';
  toast('ok','Saiu','Sess√£o encerrada.');
}

function setupLoginEnter(){
  const input = $('inpRamal');
  if (!input) return;
  input.addEventListener('keydown', event=>{
    if (event.key === 'Enter'){
      event.preventDefault();
      doLogin();
    }
  });
}

setupLoginEnter();

/* =========================
   HOME
========================= */
function renderHome(){
  $('homeShiftTitle').textContent = `${S.isAdm ? 'Plant√£o Administrativo' : 'Plant√£o Assistencial'} ‚Äî Ramal ${S.user?.ramal || '‚Äî'}`;
  $('homeShiftTime').textContent = 'Turno atual: 07:00‚Äì19:00';
  $('homeShiftUnit').textContent = S.user?.setor || 'Centro de comando';
  $('homeSepseAbertos').textContent = '3';
  $('homePendentes').textContent = '1';
  $('homeConcluidos').textContent = '2';
  $('homeUpdated').textContent = 'h√° 2 min';

  const alertBox = $('homeAlerts');
  alertBox.innerHTML = '';
  const alerts = [
    { text:'‚è∞ 1 protocolo precisa confirma√ß√£o 6h', level:'warn' },
    { text:'üìû Laborat√≥rio sem contato h√° 40 min', level:'warn' },
    { text:'‚ùó Sepse aberto h√° > 2h', level:'warn' }
  ];
  alerts.forEach(a=>{
    const el = document.createElement('div');
    el.className = 'alert-item';
    el.innerHTML = `<strong>${escapeHtml(a.text)}</strong>`;
    alertBox.appendChild(el);
  });

  const actionBox = $('homeActions');
  actionBox.innerHTML = '';
  const actions = [
    { title:'Nova Solicita√ß√£o', meta:'√ìbito ¬∑ Interconsulta ¬∑ Exames', onClick:()=>go('solicitacaoNova') },
    { title:'Minhas Solicita√ß√µes', meta:'Somente deste ramal', onClick:()=>go('solicitacoesMeus') },
    { title:'Meus Protocolos', meta:'Acompanhamento r√°pido', onClick:()=>go('sepseMeus') }
  ];
  if (S.isAdm){
    actions.push({ title:'Painel de Solicita√ß√µes', meta:'Vis√£o ADM', onClick:()=>go('solicitacoesPlantao') });
    actions.push({ title:'Painel do Plant√£o', meta:'Comando central', onClick:()=>go('plantao') });
  }

  actions.forEach(a=>{
    const el = document.createElement('div');
    el.className = 'action-card';
    el.onclick = a.onClick;
    el.innerHTML = `
      <div>
        <b>${escapeHtml(a.title)}</b>
        <div><span>${escapeHtml(a.meta)}</span></div>
      </div>
      <span class="chip">Ir</span>
    `;
    actionBox.appendChild(el);
  });
}

/* =========================
   SOLICITA√á√ïES GERAIS
========================= */
function atualizarCamposSolicitacao(){
  const tipo = $('gTipo').value;
  $('grpObito').style.display = tipo === 'OBITO' ? 'block' : 'none';
  $('grpInterconsulta').style.display = tipo === 'INTERCONSULTA' ? 'block' : 'none';
  $('grpExames').style.display = tipo === 'EXAMES' ? 'block' : 'none';
}

function criarSolicitacao(){
  const tipo = $('gTipo').value;
  const payload = {
    tipo,
    nomeSolicitante: $('gNomeSolicitante').value.trim(),
    prioridade: $('gPrioridade').value,
    observacao: $('gObservacao').value.trim(),
    setor: S.user?.setor || '',
    ramal: S.user?.ramal || ''
  };

  if (tipo === 'OBITO'){
    payload.paciente = $('gObitoPaciente').value.trim();
    payload.prontuario = $('gObitoProntuario').value.trim();
    payload.leito = $('gObitoLeito').value.trim();
    payload.clinica = $('gObitoClinica').value.trim();
    payload.dataObito = $('gObitoData').value;
    if (!payload.paciente || !payload.prontuario){
      return toast('warn','Dados obrigat√≥rios','Paciente e prontu√°rio s√£o obrigat√≥rios.');
    }
  }
  if (tipo === 'INTERCONSULTA'){
    payload.paciente = $('gInterPaciente').value.trim();
    payload.prontuario = $('gInterProntuario').value.trim();
    payload.clinica = $('gInterClinica').value.trim();
    payload.especialidade = $('gInterEspecialidade').value.trim();
    if (!payload.paciente || !payload.prontuario || !payload.especialidade){
      return toast('warn','Dados obrigat√≥rios','Paciente, prontu√°rio e especialidade s√£o obrigat√≥rios.');
    }
  }
  if (tipo === 'EXAMES'){
    payload.paciente = $('gExamePaciente').value.trim();
    payload.prontuario = $('gExameProntuario').value.trim();
    payload.exame = $('gExameNome').value.trim();
    payload.dataSolicitacao = $('gExameData').value;
    payload.solicitante = $('gExameSolicitante').value.trim();
    if (!payload.paciente || !payload.prontuario || !payload.exame){
      return toast('warn','Dados obrigat√≥rios','Paciente, prontu√°rio e exame s√£o obrigat√≥rios.');
    }
  }

  showLoader(true);
  google.script.run.withSuccessHandler(id=>{
    showLoader(false);
    toast('ok','Solicita√ß√£o aberta','Registro salvo com sucesso.');
    abrirDetalheSolicitacao(id);
  }).criarSolicitacaoGeral(payload);
}

function carregarSolicitacoesMeus(){
  showLoader(true);
  google.script.run.withSuccessHandler(list=>{
    showLoader(false);
    const box = $('solicitacoesMeusList');
    box.innerHTML = '';
    if (!list || !list.length){
      box.innerHTML = `<div class="cardrow"><div class="sub">Nenhuma solicita√ß√£o encontrada.</div></div>`;
      return;
    }
    list.forEach(s=>{
      const el = document.createElement('div');
      el.className = 'cardrow';
      el.onclick = ()=>abrirDetalheSolicitacao(s.id);
      el.innerHTML = `
        <div class="top">
          <div>
            <b>${escapeHtml(formatTipoSolicitacao(s.tipo))}</b>
            <div class="sub">${escapeHtml(s.setor||'‚Äî')} ¬∑ Ramal ${escapeHtml(s.ramal||'‚Äî')}</div>
          </div>
          <span class="chip">${escapeHtml(s.status)}</span>
        </div>
        <div class="metaLine">
          <span class="chip">${new Date(s.abertura).toLocaleString()}</span>
          <span class="chip">${escapeHtml(s.prioridade||'NORMAL')}</span>
        </div>
      `;
      box.appendChild(el);
    });
  }).listarSolicitacoesPorRamal(S.user.ramal);
}

function carregarSolicitacoesPlantao(){
  if (!S.isAdm) return;
  showLoader(true);
  const filtros = {
    status: $('fltSolicStatus').value,
    tipo: $('fltSolicTipo').value
  };
  google.script.run.withSuccessHandler(list=>{
    showLoader(false);
    const box = $('solicitacoesPlantaoList');
    box.innerHTML = '';
    if (!list || !list.length){
      box.innerHTML = `<div class="cardrow"><div class="sub">Nenhuma solicita√ß√£o.</div></div>`;
      return;
    }
    list.forEach(s=>{
      const el = document.createElement('div');
      el.className = 'cardrow';
      el.onclick = ()=>abrirDetalheSolicitacao(s.id);
      el.innerHTML = `
        <div class="top">
          <div>
            <b>${escapeHtml(formatTipoSolicitacao(s.tipo))}</b>
            <div class="sub">${escapeHtml(s.setor||'‚Äî')} ¬∑ Ramal ${escapeHtml(s.ramal||'‚Äî')}</div>
          </div>
          <span class="chip">${escapeHtml(s.status)}</span>
        </div>
        <div class="metaLine">
          <span class="chip">${new Date(s.abertura).toLocaleString()}</span>
          <span class="chip">${escapeHtml(s.prioridade||'NORMAL')}</span>
        </div>
      `;
      box.appendChild(el);
    });
  }).listarSolicitacoesParaPlantao(filtros);
}

function abrirDetalheSolicitacao(id){
  showLoader(true);
  S.current.solicitacaoId = id;
  google.script.run.withSuccessHandler(s=>{
    showLoader(false);
    if (!s){
      toast('bad','Solicita√ß√£o n√£o encontrada','Verifique o ID.');
      return;
    }
    S.current.solicitacao = s;
    renderDetalheSolicitacao();
    go('solicitacaoDetalhe');
  }).obterSolicitacaoDetalhe(id);
}

function renderDetalheSolicitacao(){
  const s = S.current.solicitacao;
  $('gDetalheTipo').textContent = formatTipoSolicitacao(s.tipo);
  $('gDetalheStatus').textContent = s.status;

  const detalhe = s.detalhe || {};
  let info = '';
  if (s.tipo === 'OBITO'){
    info = `
      <div class="sub">Paciente ${escapeHtml(detalhe.paciente||'‚Äî')} ¬∑ Prontu√°rio ${escapeHtml(detalhe.prontuario||'‚Äî')}</div>
      <div class="sub">Leito ${escapeHtml(detalhe.leito||'‚Äî')} ¬∑ Cl√≠nica ${escapeHtml(detalhe.clinica||'‚Äî')}</div>
      <div class="sub">Data do √≥bito ${detalhe.dataObito ? new Date(detalhe.dataObito).toLocaleString() : '‚Äî'}</div>
    `;
  }
  if (s.tipo === 'INTERCONSULTA'){
    info = `
      <div class="sub">Paciente ${escapeHtml(detalhe.paciente||'‚Äî')} ¬∑ Prontu√°rio ${escapeHtml(detalhe.prontuario||'‚Äî')}</div>
      <div class="sub">Cl√≠nica ${escapeHtml(detalhe.clinica||'‚Äî')} ¬∑ Especialidade ${escapeHtml(detalhe.especialidade||'‚Äî')}</div>
    `;
  }
  if (s.tipo === 'EXAMES'){
    info = `
      <div class="sub">Paciente ${escapeHtml(detalhe.paciente||'‚Äî')} ¬∑ Prontu√°rio ${escapeHtml(detalhe.prontuario||'‚Äî')}</div>
      <div class="sub">Exame ${escapeHtml(detalhe.exame||'‚Äî')} ¬∑ Solicitante ${escapeHtml(detalhe.solicitante||'‚Äî')}</div>
      <div class="sub">Data da solicita√ß√£o ${detalhe.dataSolicitacao ? new Date(detalhe.dataSolicitacao).toLocaleString() : '‚Äî'}</div>
    `;
  }

  $('gDetalheCard').innerHTML = `
    <div class="cardrow">
      <b>${escapeHtml(s.nomeSolicitante || 'Solicita√ß√£o')}</b>
      ${info}
      <div class="metaLine">
        <span class="chip">Abertura ${new Date(s.abertura).toLocaleString()}</span>
        <span class="chip">${escapeHtml(s.prioridade||'NORMAL')}</span>
      </div>
      ${s.observacao ? `<div class="sub">Obs: ${escapeHtml(s.observacao)}</div>` : ''}
    </div>
  `;
}

function formatTipoSolicitacao(tipo){
  if (tipo === 'OBITO') return 'Declara√ß√£o de √ìbito';
  if (tipo === 'INTERCONSULTA') return 'Interconsulta pendente';
  if (tipo === 'EXAMES') return 'Exame Pendente';
  return tipo || 'Solicita√ß√£o';
}

/* =========================
   SEPSE - Criar
========================= */
function criarSepse(){
  const payload = {
    paciente: $('sPaciente').value.trim(),
    prontuario: $('sProntuario').value.trim(),
    leito: $('sLeito').value.trim(),
    unidade: $('sUnidade').value.trim(),
    medico: $('sMedico').value.trim(),
    observacao: $('sObs').value.trim(),
    setor: S.user?.setor || 'SOLICITANTE',
    ramal: S.user?.ramal || ''
  };

  if (!payload.paciente || !payload.prontuario){
    return toast('warn','Dados obrigat√≥rios','Paciente e prontu√°rio s√£o obrigat√≥rios.');
  }

  showLoader(true);
  google.script.run.withSuccessHandler(id=>{
    showLoader(false);
    toast('ok','Protocolo criado','Sepse aberta com sucesso.');
    abrirDetalheSepse(id);
  }).criarProtocoloSepse(payload);
}

/* =========================
   SEPSE - Listar meus
========================= */
function carregarMeus(){
  showLoader(true);
  google.script.run.withSuccessHandler(list=>{
    showLoader(false);
    const box = $('meusList');
    box.innerHTML = '';
    if (!list || !list.length){
      box.innerHTML = `<div class="cardrow"><div class="sub">Nenhum protocolo encontrado.</div></div>`;
      return;
    }
    list.forEach(p=>{
      const el = document.createElement('div');
      el.className = 'cardrow';
      el.onclick = ()=>abrirDetalheSepse(p.id);
      el.innerHTML = `
        <div class="top">
          <div>
            <b>${escapeHtml(p.paciente)}</b>
            <div class="sub">Prontu√°rio ${escapeHtml(p.prontuario)} ¬∑ ${escapeHtml(p.unidade||'‚Äî')}</div>
          </div>
          <span class="chip ${p.status==='ABERTO'?'red':p.status==='CONCLUIDO'?'green':'yellow'}">${escapeHtml(p.status)}</span>
        </div>
        <div class="metaLine">
          <span class="chip">${new Date(p.abertura).toLocaleString()}</span>
        </div>
      `;
      box.appendChild(el);
    });
  }).listarSepsePorRamal(S.user.ramal);
}

/* =========================
   PLANT√ÉO - Listar todos
========================= */
function carregarPlantao(){
  if (!S.isAdm) return;
  showLoader(true);
  const filtros = { status: $('fltStatus').value };
  google.script.run.withSuccessHandler(list=>{
    showLoader(false);
    const box = $('plantaoList');
    box.innerHTML = '';
    if (!list || !list.length){
      box.innerHTML = `<div class="cardrow"><div class="sub">Nenhum protocolo.</div></div>`;
      return;
    }
    list.forEach(p=>{
      const el = document.createElement('div');
      el.className = 'cardrow';
      el.onclick = ()=>abrirDetalheSepse(p.id);
      el.innerHTML = `
        <div class="top">
          <div>
            <b>${escapeHtml(p.paciente)}</b>
            <div class="sub">
              Prontu√°rio ${escapeHtml(p.prontuario)} ¬∑ ${escapeHtml(p.unidade||'‚Äî')} ¬∑ ${escapeHtml(p.medico||'‚Äî')}
            </div>
          </div>
          <span class="chip ${p.status==='ABERTO'?'red':p.status==='CONCLUIDO'?'green':'yellow'}">${escapeHtml(p.status)}</span>
        </div>
        <div class="metaLine">
          <span class="chip">Abertura: ${new Date(p.abertura).toLocaleString()}</span>
        </div>
      `;
      box.appendChild(el);
    });
  }).listarSepseParaPlantao(filtros);
}

/* =========================
   SEPSE - Detalhe
========================= */
function abrirDetalheSepse(id){
  showLoader(true);
  S.current.sepseId = id;

  google.script.run.withSuccessHandler(p=>{
    S.current.sepse = p;
    google.script.run.withSuccessHandler(tl=>{
      S.current.timeline = tl;
      showLoader(false);
      renderDetalheSepse();
      go('sepseDetalhe');
    }).carregarTimelineSepse(id);
  }).obterProtocoloSepse(id);
}

function renderDetalheSepse(){
  const p = S.current.sepse;
  const tl = S.current.timeline;

  $('dStatus').textContent = p.status;
  $('dMeta').textContent = `Prontu√°rio ${p.prontuario} ¬∑ ${p.unidade||'‚Äî'}`;

  $('detailCard').innerHTML = `
    <div class="cardrow">
      <b>${escapeHtml(p.paciente)}</b>
      <div class="sub">
        Leito ${escapeHtml(p.leito||'‚Äî')} ¬∑ M√©dico ${escapeHtml(p.medico||'‚Äî')}
      </div>
      <div class="metaLine">
        <span class="chip">Abertura ${new Date(p.abertura).toLocaleString()}</span>
      </div>
    </div>
  `;

  const acts = [];
  acts.push(`<button class="btn" onclick="openLigacao()">Registrar liga√ß√£o</button>`);
  acts.push(`<button class="btn" onclick="confirmar6h()">Confirmar 6h</button>`);

  if (S.isAdm){
    acts.push(`<button class="btn danger" onclick="confirmarCancelamento()">Cancelar</button>`);
    acts.push(`<button class="btn primary" onclick="concluir()">Concluir</button>`);
  } else {
    acts.push(`<button class="btn" onclick="solicitarCancelamento()">Solicitar cancelamento</button>`);
  }

  $('detailActions').innerHTML = acts.join('');

  const box = $('timeline');
  box.innerHTML = '';
  if (!tl.length){
    box.innerHTML = `<div class="ev"><p>Sem eventos ainda.</p></div>`;
    return;
  }

  tl.forEach(e=>{
    const el = document.createElement('div');
    el.className = 'ev';
    el.innerHTML = `
      <div class="h">
        <b>${escapeHtml(e.tipo)}</b>
        <span>${new Date(e.data_hora).toLocaleString()}</span>
      </div>
      <p>${escapeHtml(e.descricao)}</p>
      <div class="tags">
        <span class="chip">${escapeHtml(e.setor||'‚Äî')}</span>
        <span class="chip">Ramal ${escapeHtml(e.ramal||'‚Äî')}</span>
      </div>
    `;
    box.appendChild(el);
  });
}

/* =========================
   A√á√ïES SEPSE
========================= */
function openLigacao(){
  const sel = $('mSetor');
  sel.innerHTML = '';
  S.setoresSepse.forEach(s=>{
    const o = document.createElement('option');
    o.value = s.nome;
    o.textContent = s.nome;
    sel.appendChild(o);
  });
  $('mObs').value = '';
  $('modalBack').style.display='flex';
}

function closeModal(){
  $('modalBack').style.display='none';
}

function confirmLigacao(){
  const setor = $('mSetor').value;
  const resultado = $('mResultado').value;
  const obs = $('mObs').value.trim();

  showLoader(true);
  google.script.run.withSuccessHandler(()=>{
    showLoader(false);
    closeModal();
    toast('ok','Liga√ß√£o registrada',`${setor} ¬∑ ${resultado}`);
    abrirDetalheSepse(S.current.sepseId);
  }).registrarLigacaoSepse(S.current.sepseId, setor, S.user.ramal, resultado, obs);
}

function confirmar6h(){
  showLoader(true);
  google.script.run.withSuccessHandler(()=>{
    showLoader(false);
    toast('ok','Confirma√ß√£o registrada','Contato ap√≥s 6h registrado.');
    abrirDetalheSepse(S.current.sepseId);
  }).confirmarSepse6h(S.current.sepseId, S.user.ramal);
}

function solicitarCancelamento(){
  showLoader(true);
  google.script.run.withSuccessHandler(()=>{
    showLoader(false);
    toast('warn','Solicita√ß√£o enviada','Plant√£o precisa confirmar.');
    abrirDetalheSepse(S.current.sepseId);
  }).solicitarCancelamentoSepse(S.current.sepseId, S.user.ramal);
}

function confirmarCancelamento(){
  showLoader(true);
  google.script.run.withSuccessHandler(()=>{
    showLoader(false);
    toast('bad','Protocolo cancelado','Cancelamento confirmado pelo plant√£o.');
    go('plantao');
  }).confirmarCancelamentoSepse(S.current.sepseId, S.user.ramal);
}

function concluir(){
  showLoader(true);
  google.script.run.withSuccessHandler(()=>{
    showLoader(false);
    toast('ok','Protocolo conclu√≠do','Encerrado com sucesso.');
    go('plantao');
  }).concluirSepse(S.current.sepseId, S.user.ramal);
}
</script>

</body>
</html>
